<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Visual ReqM2</title>
    <style>
    #app {
      display: flex;
      display: -webkit-flex;
      flex-direction: column;
      -webkit-flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #header {
      flex: 0 0 auto;
      -webkit-flex: 0 0 auto;
      line-height: 1.3;
    }

    #panes {
      display: flex;
      display: -webkit-flex;
      flex: 1 1 auto;
      -webkit-flex: 1 1 auto;
    }

    #graph {
      display: flex;
      display: -webkit-flex;
      flex-direction: column;
      -webkit-flex-direction: column;
    }

    #options {
      flex: 0 0 auto;
      -webkit-flex: 0 0 auto;
    }

    #output {
      flex: 1 1 auto;
      -webkit-flex: 1 1 auto;
      position: relative;
      overflow: auto;
    }


    #editor {
      border-right: 1px solid #ccc;
    }

    #header {
      background: #eee;
      border-bottom: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    #header b {
      font-size: 18px;
    }

    #options {
      background: #eee;
      border-bottom: 1px solid #ccc;
      padding: 8px;
    }

    #options label {
      margin-right: 8px;
    }

    #options #raw.disabled {
      opacity: 0.5;
    }

    #output svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #output #text {
      font-size: 12px;
      font-family: monaco, courier, monospace;
      white-space: pre;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
    }

    #output img {
      display: block;
      margin: 0 auto;
    }

    #output.working svg, #output.error svg,
    #output.working #text, #output.error #text,
    #output.working img, #output.error img {
      opacity: 0.4;
    }

    #output.error #error {
      display: inherit;
    }

    #output #error {
      display: none;
      position: absolute;
      top: 20px;
      left: 20px;
      margin-right: 20px;
      background: red;
      color: white;
      z-index: 1;
    }

    .gutter {
      background-color: #eee;
      background-repeat: no-repeat;
      background-position: 50%;
    }

    .gutter.gutter-horizontal {
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
      cursor: ew-resize;
    }

    .split {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;

      overflow-y: auto;
      overflow-x: hidden;
    }

    .split.split-horizontal, .gutter.gutter-horizontal {
      height: 100%;
      float: left;
    }

    .table.oreqm, tr, td {
      table-layout: fixed;
    }

    .table.table.oreqm, td {
      width: 120px;
    }

    table {
      border-collapse: collapse;
    }

    table, th, td {
      border: 1px solid black;
    }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="header">
        <b>Visual ReqM2</b> Read more at <a href="https://github.com/mox17/">the GitHub repository</a>.
      </div>
      <div id="panes" class="split split-horizontal">
        <div id="editor" class="split">
          <h2>ReqM2 file</h2>
          <button type="button" onclick="get_main_oreqm_file()">Select main .oreqm file</button>
          <p/>
          <table class="table.oreqm" >
            <tr><td>name</td><td id="name"></td></tr>
            <tr><td>size</td><td id="size"></td></tr>
            <tr><td>timestamp</td><td id="timestamp"></td></tr>
          </table>
          <p id="values"></p>

          <h2>Filter criteria</h2>
          <input placeholder="<id> regex" name="id_regex"/>
          <p/>
          <input placeholder="any text regex" name="txt_regex"/>
          <p/>
          <input placeholder="excluded <id>s" name="txt_regex"/>
          <p/>
          <input placeholder="excluded doctypes" name="txt_regex"/>
          <p/>

          <button type="button" onclick="filter_graph()">Filter graph</button>
          <p/>
          <button type="button" onclick="save_svg()">save svg</button>
          <p/>
          <button type="button" onclick="save_png()">save png</button>
          <p/>
        </div>
        <div id="graph" class="split">
          <div id="options">
            <label id="engine">
              Engine:
              <select>
                <option>circo</option>
                <option selected>dot</option>
                <option>fdp</option>
                <option>neato</option>
                <option>osage</option>
                <option>twopi</option>
              </select>
            </label>

            <label id="format">
              Format:
              <select>
                <option selected>svg</option>
                <option>png-image-element</option>
                <option>json</option>
                <option>xdot</option>
                <option>plain</option>
                <option>ps</option>
              </select>
            </label>

            <label id="raw">
              <input type="checkbox"> Show raw output
            </label>
          </div>
        <div id="output">
          <div id="error"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="./tmp/viz-js.com/js/ace/ace.js"></script>
  <script src="./tmp/viz-js.com/bower_components/viz.js/viz.js"></script>
  <script src="./tmp/viz-js.com/bower_components/fabric.js/dist/fabric.min.js"></script>
  <script src="./tmp/viz-js.com/bower_components/Split.js/split.min.js"></script>
  <script src="./tmp/viz-js.com/bower_components/svg-pan-zoom/dist/svg-pan-zoom.min.js"></script>
  <script src="oreqm.js"></script>
  <script src="ReqM2Oreqm.js"></script>
  <script>

  var beforeUnloadMessage = null;

  var resizeEvent = new Event("paneresize");
  Split(['#editor', '#graph'], {
    sizes: [15, 85],
    onDragEnd: function() {
      var svgOutput = document.getElementById("svg_output");
      if (svgOutput != null) {
        svgOutput.dispatchEvent(resizeEvent);
      }
    }
  });

  var parser = new DOMParser();
  var worker;
  var result;
  var oreqm_main

  function updateGraph() {
    if (worker) {
      worker.terminate();
    }

    document.querySelector("#output").classList.add("working");
    document.querySelector("#output").classList.remove("error");

    worker = new Worker("./worker.js");

    worker.onmessage = function(e) {
      document.querySelector("#output").classList.remove("working");
      document.querySelector("#output").classList.remove("error");

      result = e.data;

      updateOutput();
    }

    worker.onerror = function(e) {
      document.querySelector("#output").classList.remove("working");
      document.querySelector("#output").classList.add("error");

      var message = e.message === undefined ? "An error occurred while processing the graph input." : e.message;

      var error = document.querySelector("#error");
      while (error.firstChild) {
        error.removeChild(error.firstChild);
      }

      document.querySelector("#error").appendChild(document.createTextNode(message));

      console.error(e);
      e.preventDefault();
    }

    let dot_source = oreqm_main != null ? oreqm_main.get_dot() : "digraph foo {\nfoo -> bar\nfoo -> baz\n}\n"
    var params = {
      src: dot_source, //editor.getSession().getDocument().getValue(),
      options: {
        engine: document.querySelector("#engine select").value,
        format: document.querySelector("#format select").value
      }
    };

    // Instead of asking for png-image-element directly, which we can't do in a worker,
    // ask for SVG and convert when updating the output.

    if (params.options.format == "png-image-element") {
      params.options.format = "svg";
    }

    worker.postMessage(params);
  }

  function updateOutput() {
    var graph = document.querySelector("#output");

    var svg = graph.querySelector("svg");
    if (svg) {
      graph.removeChild(svg);
    }

    var text = graph.querySelector("#text");
    if (text) {
      graph.removeChild(text);
    }

    var img = graph.querySelector("img");
    if (img) {
      graph.removeChild(img);
    }

    if (!result) {
      return;
    }

    if (document.querySelector("#format select").value == "svg" && !document.querySelector("#raw input").checked) {
      var svg = parser.parseFromString(result, "image/svg+xml").documentElement;
      svg.id = "svg_output";
      graph.appendChild(svg);

      panZoom = svgPanZoom(svg, {
        zoomEnabled: true,
        controlIconsEnabled: true,
        fit: true,
        center: true,
        minZoom: 0.02
      });

      svg.addEventListener('paneresize', function(e) {
        panZoom.resize();
      }, false);
      window.addEventListener('resize', function(e) {
        panZoom.resize();
      });
    } else if (document.querySelector("#format select").value == "png-image-element") {
      var image = Viz.svgXmlToPngImageElement(result);
      graph.appendChild(image);
    } else {
      var text = document.createElement("div");
      text.id = "text";
      text.appendChild(document.createTextNode(result));
      graph.appendChild(text);
    }
  }

  window.addEventListener("beforeunload", function(e) {
    return beforeUnloadMessage;
  });


  document.querySelector("#engine select").addEventListener("change", function() {
      updateGraph();
    });

    document.querySelector("#format select").addEventListener("change", function() {
      if (document.querySelector("#format select").value === "svg") {
        document.querySelector("#raw").classList.remove("disabled");
        document.querySelector("#raw input").disabled = false;
      } else {
        document.querySelector("#raw").classList.add("disabled");
        document.querySelector("#raw input").disabled = true;
      }

      updateGraph();
    });

    document.querySelector("#raw input").addEventListener("change", function() {
      updateOutput();
    });

  function get_main_oreqm_file() {
    var input = document.createElement('input');
    input.type = 'file';

    input.onchange = e => {
      // getting a hold of the file reference
      var file = e.target.files[0];
      // setting up the reader
      var reader = new FileReader();
      reader.readAsText(file,'UTF-8');
      // here we tell the reader what to do when it's done reading...
      reader.onload = readerEvent => {
        var content = readerEvent.target.result; // this is the content!
        //console.log( file );
        document.getElementById('name').innerHTML = file.name
        document.getElementById('size').innerHTML = file.size+" bytes"
        //parse(content);
        oreqm_main = new ReqM2Oreqm(content, [], [])
        document.getElementById('timestamp').innerHTML = oreqm_main.get_time()
        //console.log(oreqm_main)
        updateGraph();
      }
    }
    input.click();
  }
/*
  var xmlDoc;
  function parse(content) {
    //Create a parser
    var parser = new DOMParser();
    xmlDoc = parser.parseFromString(content,"text/xml");
    //Parse!
    document.getElementById("timestamp").innerText = "timestamp: " + xmlDoc.evaluate("//timestamp",xmlDoc).iterateNext().textContent;
    find_doctypes2(xmlDoc)
  }

  function find_doctypes2(xml) {
    var message = "The list of specobjects sections:<br />";
    var specobjects = xml.getElementsByTagName("specobjects")
    var doctypes = new Set()
    var i;
    for (i = 0; i < specobjects.length; i++) {
      var doctype = specobjects[i].getAttributeNode("doctype").value;
      //console.log( doctype );
      if (! doctypes.has(doctype)) {
          message += "<b>" + doctype + "</b><br />";
          doctypes.add(doctype)
        }
        get_specobject_list(specobjects[i], doctype)
    }
    var info = document.getElementById ("info");
    info.innerHTML = message;
  }
  */
    </script>
  <!--
  <span class="level1">Span 1</span>
  <div id="container">
      <span class="level2">Span 2</span>
      <div>
          <span class="level3">Span 3</span>
          <span class="level3">Span 4</span>
      </div>
      <span class="level2">Span 5</span>
      <span class="level2">Span 6</span>
  </div>
  <span class="level1">Span 7</span>
  <br /><br />
  <div id="info" style="background-color:#e0b0b0; width:400px"></div>
-->

</body>
</html>
