<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Visual ReqM2</title>
    <style>
    #app {
      display: flex;
      display: -webkit-flex;
      flex-direction: column;
      -webkit-flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #header {
      flex: 0 0 auto;
      -webkit-flex: 0 0 auto;
      line-height: 1.3;
    }

    #panes {
      display: flex;
      display: -webkit-flex;
      flex: 1 1 auto;
      -webkit-flex: 1 1 auto;
    }

    #graph {
      display: flex;
      display: -webkit-flex;
      flex-direction: column;
      -webkit-flex-direction: column;
    }

    #options {
      flex: 0 0 auto;
      -webkit-flex: 0 0 auto;
    }

    #output {
      flex: 1 1 auto;
      -webkit-flex: 1 1 auto;
      position: relative;
      overflow: auto;
    }


    #oreqm {
      border-right: 1px solid #ccc;
    }

    #header {
      background: #eee;
      border-bottom: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    #header b {
      font-size: 18px;
    }

    #options {
      background: #eee;
      border-bottom: 1px solid #ccc;
      padding: 8px;
    }

    #options label {
      margin-right: 8px;
    }

    #options #raw.disabled {
      opacity: 0.5;
    }

    #output svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #output #text {
      font-size: 12px;
      font-family: monaco, courier, monospace;
      white-space: pre;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
    }

    #output img {
      display: block;
      margin: 0 auto;
    }

    #output.working svg, #output.error svg,
    #output.working #text, #output.error #text,
    #output.working img, #output.error img {
      opacity: 0.4;
    }

    #output.error #error {
      display: inherit;
    }

    #output #error {
      display: none;
      position: absolute;
      top: 20px;
      left: 20px;
      margin-right: 20px;
      background: red;
      color: white;
      z-index: 1;
    }

    .gutter {
      background-color: #eee;
      background-repeat: no-repeat;
      background-position: 50%;
    }

    .gutter.gutter-horizontal {
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
      cursor: ew-resize;
    }

    .split {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;

      overflow-y: auto;
      overflow-x: hidden;
    }

    .split.split-horizontal, .gutter.gutter-horizontal {
      height: 100%;
      float: left;
    }

    .table.oreqm, td {
      width: 120px;
      table-layout: fixed;
    }

    table {
      table-layout: fixed;
      border-collapse: collapse;
    }

    table .absorbing-column {
      width: 100%;
    }
    table, th, td {
      border: 1px solid black;
      padding: 10px;
    }

    html, body {
        font-family: arial;
    }

    #oreqm {
      margin-left: 8px;
    }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="header">
        <b>Visual ReqM2</b> Read more at <a href="https://github.com/mox17/">the GitHub repository</a>.
      </div>
      <div id="panes" class="split split-horizontal">
        <div id="oreqm" class="split">
          <b>ReqM2 file</b><br/>
          <table class="table.oreqm" >
            <tr><td width="1%">name</td><td id="name" class="absorbing-column"></td></tr>
            <tr><td width="1%">size</td><td id="size"></td></tr>
            <tr><td width="1%">timestamp</td><td id="timestamp"></td></tr>
          </table>
          <p/>
          <button type="button" onclick="get_main_oreqm_file()">Select main .oreqm file</button>
          <p/>
          <button type="button" onclick="get_ref_oreqm_file()">Select reference .oreqm file</button>
          <p id="values"></p>

          <h2>Filter criteria</h2>
          <textarea id="search_regex" rows="3" cols="25"
                    wrap="off" placeholder="search regex" ></textarea>
          <br>
          <label id="id_checkbox">
            <input type="checkbox"> Search &lt;id&gt; only
          </label>
          <p/>
          <textarea id="excluded_ids" rows="3" cols="25"
                    wrap="off" placeholder="excluded <id>s" ></textarea>
          <p/>
          <textarea id="excluded_doctypes" rows="3" cols="25"
                    wrap="off" placeholder="excluded doctypes" ></textarea>
          <p/>
          <button type="button" onclick="filter_graph()">Update graph</button>
          <p/>
          <button type="button" onclick="save_svg()">save graph</button>
          <p/>
          <h4>doctypes</h4>
          <div id="doctype_table"></div>
          <div id="ref_oreqm">
            <h3>Ref. file</h3>
            <table class="table.oreqm" >
              <tr><td width="1%">name</td><td id="ref_name" class="absorbing-column"></td></tr>
              <tr><td width="1%">size</td><td id="ref_size"></td></tr>
              <tr><td width="1%">timestamp</td><td id="ref_timestamp"></td></tr>
            </table>
          </div>
        </div>
        <div id="graph" class="split">
          <div id="options">
            <!--
            <label id="engine">
              Engine:
              <select>
                <option>circo</option>
                <option selected>dot</option>
                <option>fdp</option>
                <option>neato</option>
                <option>osage</option>
                <option>twopi</option>
              </select>
            </label>
            -->
            <label id="format">
              Format:
              <select>
                <option selected>svg</option>
                <option>png-image-element</option>
                <option>json</option>
                <option>xdot</option>
                <option>plain</option>
                <option>ps</option>
              </select>
            </label>

            <label id="raw">
              <input type="checkbox"> Show raw output
            </label>
          </div>
        <div id="output">
          <div id="error"></div>
        </div>
      </div>
    </div>
  </div>

  <!--<script src="./tmp/viz-js.com/js/ace/ace.js"></script>-->
  <script src="./tmp/viz-js.com/bower_components/viz.js/viz.js"></script>
  <script src="./tmp/viz-js.com/bower_components/fabric.js/dist/fabric.min.js"></script>
  <script src="./tmp/viz-js.com/bower_components/Split.js/split.min.js"></script>
  <script src="./tmp/viz-js.com/bower_components/svg-pan-zoom/dist/svg-pan-zoom.min.js"></script>
  <script src="color.js"></script>
  <script src="oreqm.js"></script>
  <script src="ReqM2Oreqm.js"></script>
  <script>

  var beforeUnloadMessage = null;

  var resizeEvent = new Event("paneresize");
  Split(['#oreqm', '#graph'], {
    sizes: [15, 85],
    onDragEnd: function() {
      var svgOutput = document.getElementById("svg_output");
      if (svgOutput != null) {
        svgOutput.dispatchEvent(resizeEvent);
      }
    }
  });

  var parser = new DOMParser();
  var worker;
  var result;
  var oreqm_main
  var title
  var oreqm_main_filename = 'no file selected'
  var oreqm_main_timestamp = 'no time'
  var oreqm_ref_filename = ''
  var oreqm_ref_timestamp = ''

  function updateGraph() {
    if (worker) {
      worker.terminate();
    }

    document.querySelector("#output").classList.add("working");
    document.querySelector("#output").classList.remove("error");

    worker = new Worker("./worker.js");

    worker.onmessage = function(e) {
      document.querySelector("#output").classList.remove("working");
      document.querySelector("#output").classList.remove("error");

      result = e.data;

      updateOutput();
    }

    worker.onerror = function(e) {
      document.querySelector("#output").classList.remove("working");
      document.querySelector("#output").classList.add("error");

      var message = e.message === undefined ? "An error occurred while processing the graph input." : e.message;

      var error = document.querySelector("#error");
      while (error.firstChild) {
        error.removeChild(error.firstChild);
      }

      document.querySelector("#error").appendChild(document.createTextNode(message));

      console.error(e);
      e.preventDefault();
    }

    let dot_source = oreqm_main != null ? oreqm_main.get_dot() : "digraph foo {\nfoo -> bar\nfoo -> baz\n}\n"
    var params = {
      src: dot_source,
      options: {
        engine: "dot", //document.querySelector("#engine select").value,
        format: document.querySelector("#format select").value,
        totalMemory: 3 * 16 * 1024 *1024
      }
    };

    // Instead of asking for png-image-element directly, which we can't do in a worker,
    // ask for SVG and convert when updating the output.

    if (params.options.format == "png-image-element") {
      params.options.format = "svg";
    }

    worker.postMessage(params);
  }

  function updateOutput() {
    var graph = document.querySelector("#output");

    var svg = graph.querySelector("svg");
    if (svg) {
      graph.removeChild(svg);
    }

    var text = graph.querySelector("#text");
    if (text) {
      graph.removeChild(text);
    }

    var img = graph.querySelector("img");
    if (img) {
      graph.removeChild(img);
    }

    if (!result) {
      return;
    }

    if (document.querySelector("#format select").value == "svg" && !document.querySelector("#raw input").checked) {
      var svg = parser.parseFromString(result, "image/svg+xml").documentElement;
      svg.id = "svg_output";
      graph.appendChild(svg);

      panZoom = svgPanZoom(svg, {
        panEnabled: true,
        zoomEnabled: true,
        controlIconsEnabled: true,
        fit: true,
        center: true,
        minZoom: 0.02,
        maxZoom: 200,
        zoomScaleSensitivity: 0.3
      });

      svg.addEventListener('paneresize', function(e) {
        panZoom.resize();
      }, false);
      window.addEventListener('resize', function(e) {
        panZoom.resize();
      });
    } else if (document.querySelector("#format select").value == "png-image-element") {
      var image = Viz.svgXmlToPngImageElement(result);
      graph.appendChild(image);
    } else {
      var text = document.createElement("div");
      text.id = "text";
      text.appendChild(document.createTextNode(result));
      graph.appendChild(text);
    }
  }

  window.addEventListener("beforeunload", function(e) {
    return beforeUnloadMessage;
  });


  document.querySelector("#engine select").addEventListener("change", function() {
      updateGraph();
    });

    document.querySelector("#format select").addEventListener("change", function() {
      if (document.querySelector("#format select").value === "svg") {
        document.querySelector("#raw").classList.remove("disabled");
        document.querySelector("#raw input").disabled = false;
      } else {
        document.querySelector("#raw").classList.add("disabled");
        document.querySelector("#raw input").disabled = true;
      }

      updateGraph();
    });

    document.querySelector("#raw input").addEventListener("change", function() {
      updateOutput();
    });

  function display_doctypes_with_count(doctype_dict) {
    let doctype_names = Object.keys(doctype_dict)
    doctype_names.sort()
    console.log(doctype_names)
  }

  function get_main_oreqm_file() {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = '.oreqm,.reqm,.reqm2,.xml'

    input.onchange = e => {
      // getting a hold of the file reference
      let file = e.target.files[0];
      // setting up the reader
      let reader = new FileReader();
      reader.readAsText(file,'UTF-8');
      // here we tell the reader what to do when it's done reading...
      reader.onload = readerEvent => {
        //console.log( file );
        oreqm_main = new ReqM2Oreqm(readerEvent.target.result, [], [])
        oreqm_main_filename = file.name
        oreqm_main_timestamp = oreqm_main.get_time()
        document.getElementById('name').innerHTML = oreqm_main_filename
        document.getElementById('size').innerHTML = file.size+" bytes"
        document.getElementById('timestamp').innerHTML = oreqm_main_timestamp
        display_doctypes_with_count(oreqm_main.get_doctypes())
        //console.log(oreqm_main)
        updateGraph();
      }
    }
    input.click();
  }

  function get_ref_oreqm_file() {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = '.oreqm,.reqm,.reqm2,.xml'

    input.onchange = e => {
      // getting a hold of the file reference
      let file = e.target.files[0];
      // setting up the reader
      let reader = new FileReader();
      reader.readAsText(file,'UTF-8');
      // here we tell the reader what to do when it's done reading...
      reader.onload = readerEvent => {
        //console.log( file );
        oreqm_ref = new ReqM2Oreqm(readerEvent.target.result, [], [])
        oreqm_ref_filename = file.name
        oreqm_ref_timestamp = oreqm_main.get_time()
        document.getElementById('ref_name').innerHTML = oreqm_ref_filename
        document.getElementById('ref_size').innerHTML = file.size+" bytes"
        document.getElementById('ref_timestamp').innerHTML = oreqm_ref_timestamp
        //console.log(oreqm_main)
        compare_oreqm()
        updateGraph();
      }
    }
    input.click();
  }

  function save_svg() {
    //var search_pattern = document.querySelector("#search_regex input").value
    var search_pattern = document.getElementById("search_regex").value
    var id_checkbox = document.querySelector("#id_checkbox input").checked
    console.log(search_pattern, id_checkbox)
  }

  function filter_graph() {
    // Collect filter criteria and generate .dot data
    var search_pattern = document.getElementById("search_regex").value
    var id_checkbox = document.querySelector("#id_checkbox input").checked
    console.log(search_pattern, id_checkbox)
    search_pattern = search_pattern.trim()
    make_title()
    if (search_pattern) {
      if (id_checkbox) {
        id_search(search_pattern)
      } else {
        txt_search(search_pattern)
      }
    } else {
      // no pattern specified
      graph = oreqm_main.create_graph(select_all, "reqspec1", title, [])
    }
    console.log(graph[1], graph[2])
    updateGraph();
  }

  function handle_pruning() {
    const excluded_ids = document.getElementById("excluded_ids").value.trim()
    let ex_id_list = excluded_ids.split(/[\s\n,]+/)
    oreqm_main.set_excluded_ids(ex_id_list)
    if (excluded_ids) {
      title += "\\lDiagram excludes <id>s:\\l - {}\\l".format(ex_id_list.join("\\l - "))
      console.log(ex_id_list)
    }
    const excluded_doctypes = document.getElementById("excluded_doctypes").value.trim()
    let ex_dt_list = excluded_doctypes.split(/[\s\n,]+/)
    oreqm_main.set_excluded_doctypes(ex_dt_list)
    if (excluded_doctypes) {
      title += "\\lDiagram excludes doctypes: {}\\l".format(ex_dt_list.join(", "))
      console.log(ex_dt_list)
    }
  }

  function make_title() {
    title = "Analysis of: {} from: {}".format(oreqm_main_filename, oreqm_main_timestamp)
    handle_pruning()
  }

  function id_search(regex) {
    title += "\\lSearch <id>: '{}'\\l".format(regex.replace('\\', '\\\\'))
    var results = oreqm_main.find_reqs_with_name(regex)
    oreqm_main.clear_colors()
    oreqm_main.color_up_down(results, COLOR_UP, COLOR_DOWN)
    graph = oreqm_main.create_graph(select_color, "reqspec1", title, results)
  }

  function txt_search(regex) {
    title += "\\lSearch text: '{}'\\l".format(regex.replace('\\', '\\\\'))
    var results = oreqm_main.find_reqs_with_text(regex)
    oreqm_main.clear_colors()
    oreqm_main.color_up_down(results, COLOR_UP, COLOR_DOWN)
    graph = oreqm_main.create_graph(select_color, "reqspec1", title, results)
  }

    </script>
  </body>
</html>
