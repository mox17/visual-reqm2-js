<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Visual ReqM2</title>
    <style>
    #app {
      display: flex;
      display: -webkit-flex;
      flex-direction: column;
      -webkit-flex-direction: column;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #header {
      flex: 0 0 auto;
      -webkit-flex: 0 0 auto;
      line-height: 1.3;
    }

    #panes {
      display: flex;
      display: -webkit-flex;
      flex: 1 1 auto;
      -webkit-flex: 1 1 auto;
    }

    #graph {
      display: flex;
      display: -webkit-flex;
      flex-direction: column;
      -webkit-flex-direction: column;
    }

    #options {
      flex: 0 0 auto;
      -webkit-flex: 0 0 auto;
    }

    #output {
      flex: 1 1 auto;
      -webkit-flex: 1 1 auto;
      position: relative;
      overflow: auto;
    }

    #oreqm_div {
      border-right: 1px solid #ccc;
      background: #eee;
    }

    #header {
      background: #eee;
      border-bottom: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    #header b {
      font-size: 18px;
    }

    #options {
      background: #eee;
      border-bottom: 1px solid #ccc;
      padding: 8px;
    }

    #options label {
      margin-right: 8px;
    }

    #options #raw.disabled {
      opacity: 0.5;
    }

    #output svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #output #text {
      font-size: 12px;
      font-family: monaco, courier, monospace;
      white-space: pre;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
    }

    #output img {
      display: block;
      margin: 0 auto;
    }

    #output.working svg, #output.error svg,
    #output.working #text, #output.error #text,
    #output.working img, #output.error img {
      opacity: 0.4;
    }

    #output.error #error {
      display: inherit;
    }

    #output #error {
      display: none;
      position: absolute;
      top: 20px;
      left: 20px;
      margin-right: 20px;
      background: red;
      color: white;
      z-index: 1;
    }

    .gutter {
      background-color: #eee;
      background-repeat: no-repeat;
      background-position: 50%;
    }

    .gutter.gutter-horizontal {
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
      cursor: ew-resize;
    }

    .split {
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;

      overflow-y: auto;
      overflow-x: hidden;
    }

    .split.split-horizontal, .gutter.gutter-horizontal {
      height: 100%;
      float: left;
    }

    html, body {
        font-family: arial;
    }

    #oreqm_div {
      padding-right: 4px;
      padding-left: 4px;
      padding-top: 4px;
    }

    table.oreqm_file_table {
      font-family: Arial, Helvetica, sans-serif;
      border: 1px solid #000000;
      background-color: #FFFFFF;
      width: 100%;
      text-align: left;
    }

    table.oreqm_file_table td, table.oreqm_file_table th {
      border: 0px solid #AAAAAA;
      padding: 0px 0px;
    }

    table.oreqm_file_table tbody td {
      font-size: 12px;
    }
    table.oreqm_file_table tr:nth-child(even) {
      background: #DDDDDD;
    }

    table.doctype_table td,
    table.doctype_table p
    {
      padding-left:0px;
      padding-right:0px;
      padding-top:0px;
      padding-bottom:0px;
      margin:0px;
    }

    table.doctype_table
    {
      text-align: center;
      font-size: 13px;
      width: 100%;
    }

    textarea.search_terms {
      border-radius: 4px;
      flex: 0 0 200px;
      margin-right: 10px;
      margin-top: 4px;
      padding-right: 4px;
      font-size: 12px;
      width: 97%;
    }

    /* The Modal (background) */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1; /* Sit on top */
      padding-top: 100px; /* Location of the box */
      padding-right: 100px; /* Location of the box */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgb(0,0,0); /* Fallback color */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }

    /* The Close Button */
    .close {
      color: #aaaaaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }

    .abt_alignleft {
      float: left;
      width: 50%;
      text-align:left;
      /*margin:0;
      padding:0;*/
    }

    .abt_alignright {
      float: right;
      width: 50%;
      text-align:right;
      /*margin:0;
      padding:0;*/
    }
    /* The Modal (background) - end */

    /* svg context menu related */
    .custom-menu {
      display: none;
      z-index: 1000;
      position: absolute;
      overflow: hidden;
      border: 1px solid #555;
      white-space: nowrap;
      font-family: sans-serif;
      background: #000;
      color: #FFF;
      list-style: none;
      border-radius:1px;
      -moz-border-radius:1px;
      box-shadow: 2px 2px 2px #aaa;
    }

    .custom-menu li {
      padding: 4px 4px;
      cursor: pointer;
    }

    .custom-menu li:hover {
      background-color: #555;
    }
    /* svg context menu related - end */

    /* Status bar layout */
    .alignleft {
      float: left;
      width:35%;
      text-align:left;
      margin:0;
      padding:0;
    }

    .aligncenter {
      float: left;
      width:55%;
      text-align:center;
      margin:0;
      padding:0;
    }

    .alignright {
      float: right;
      width:10%;
      text-align:right;
      margin:0;
      padding:0;
    }
    </style>
  </head>
  <body>
    <div id="app">
      <!--
      <div id="header">
        <b>Visual ReqM2</b> Read more at <a href="https://example.com/">the web site</a>.
      </div>
      -->
      <div id="panes" class="split split-horizontal">
        <div id="oreqm_div" class="split">
          <b>ReqM2 .oreqm file</b><br/>
          <table class="oreqm_file_table" >
            <tr><td width="1%">name</td><td id="name" class="absorbing-column"></td></tr>
            <tr><td width="1%">size</td><td id="size"></td></tr>
            <tr><td width="1%">date</td><td id="timestamp"></td></tr>
          </table>
          <p/>
          <button type="button" onclick="get_main_oreqm_file()" >Load file</button>
          <p/>
          <div id="ref_oreqm">
            <b>Reference .oreqm file</b>
            <table class="oreqm_file_table">
              <tr><td width="1%">name</td><td id="ref_name" class="absorbing-column"></td></tr>
              <tr><td width="1%">size</td><td id="ref_size"></td></tr>
              <tr><td width="1%">date</td><td id="ref_timestamp"></td></tr>
            </table>
          </div>
          <p/>
          <button id="get_ref_oreqm" type="button" disabled="true" onclick="get_ref_oreqm_file()">Load file</button>
          <button id="clear_ref_oreqm" type="button" disabled="true" onclick="clear_reference()">Clear</button>
          <p></p>
          <hr>
          <b>Selection criteria</b>
          <button id="clear_filters" type="button" onclick="clear_search_regex()">Clear</button>
          <textarea class="search_terms" id="search_regex" rows="3" cols="34"
                    wrap="off" placeholder="search regex&#13;&#10;newlines are ignored&#13;&#10;rem:|chg:|new: select changes"
                    onchange="filter_change()"
                    spellcheck="false"></textarea>
          <br>
          <label id="id_checkbox">
            <input type="checkbox" onchange="filter_change()">Search &lt;id&gt; only
          </label>
          <p/>
          <b>Excluded &lt;id&gt;s</b>
          <button id="clear_filters" type="button" onclick="clear_excluded_ids()">Clear</button>
          <textarea class="search_terms" id="excluded_ids" rows="3" cols="25" spellcheck="false" onchange="filter_change()"
          wrap="off" placeholder="excluded <id>s&#13;&#10;separate with ',' or newline" ></textarea>
            <hr>
            <button type="button" onclick="filter_graph()">Update graph</button>
            <input type="checkbox" id="auto_update" onchange="auto_update_click()">auto-update</button>
          <p/>
          <hr>
          <b>Doctypes</b><br><p/>
          <button type="button" onclick="toggle_exclude()">toggle exclude</button>
          <p/>
          <div id="doctype_table"></div>
          <p/>
          <button type="button" onclick="save_colors()">save colors</button>
          <button type="button" onclick="load_colors()">load colors</button>
        </div>
        <div id="graph" class="split">
          <div id="options">
            <p class="alignleft">
              <label id="format">
                Format:
                <select>
                  <option selected>svg</option>
                  <option>png-image-element</option>
                  <!-- <option>json</option> -->
                  <!-- <option>xdot</option> -->
                  <!-- <option>plain</option> -->
                  <!-- <option>ps</option> -->
                </select>
              </label>
              <label id="raw" style="visibility: hidden;">
                <input type="checkbox" > raw
              </label>
              <label id="download_image"></label>
            </p>
            <p class="aligncenter">
              <label id="viz_working"></label>
            </p>
            <p class="alignright">
              <!-- Trigger/Open The Modal -->
              <button id="myBtn">About</button>
            </p>
          </div>
          <div style="clear: both;"></div>
          <div id="output">
            <div id="error"></div>
          </div>
        </div>
      </div>
    </div>
<!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <span class="close">&times;</span>
    <p>
      <h1>Visual ReqM2</h1>
      <p>Copyright 2020 Erling Stage<br/>
      Licensed under MIT license</p>
      <h4>Dependencies</h4>
      <p>Visual ReqM2 uses the following modules:
          <p>Viz.js 1.8.2 (Graphviz 2.40.1, Expat 2.2.5, Emscripten 1.37.33)<br/>
            Copyright 2014-2018 Michael Daines<br/>
            Licensed under MIT license<br/>
            https://github.com/mdaines/viz.js<br/></p>
          <p>
            svg-pan-zoom v3.6.1<br/>
            Copyright 2009-2010 Andrea Leofreddi<br/>
            BSD 2-Clause "Simplified" License<br/>
            https://github.com/ariutta/svg-pan-zoom<br/>
          </p>
          <p>
            fabric.js 1.6.7<br/>
            Licensed under MIT license<br/>
            https://github.com/fabricjs/fabric.js/tree/v1.6.7<br/>
          </p>
          <p>
            Split.js v1.3.5<br/>
            Copyright 2018 Nathan Cahill<br/>
            Licensed under MIT license<br/>
            https://github.com/nathancahill/split<br/>
          </p>
      </p>
    </p>
    <p class="abt_alignright">
      <h4>Tips</h4>
      <ul>
        <li>Use mouse wheel (or scroll gesture) to zoom in and out around mouse position.</li>
        <li>Use mouse-drag to pan image.</li>
        <li>Select text in image with <b>Alt</b>+drag or <b>Ctrl</b>+drag (browser dependent). </li>
        <li>Right-click menu on requirements to do <b>select / deselect / exclude</b>.</li>
        <li>Click requirement to <b>copy</b> requirement &lt;id&gt; to clipboard.</li>
      </ul>
    </p>
  </div>

</div>
<ul class='custom-menu' id="node-menu">
  <li id="menu_select"   onclick="select_node()">Select</li>
  <li id="menu_deselect" onclick="deselect_node()">De-select</li>
  <li id="menu_exclude"  onclick="exclude_node()">Exclude</li>
  <li id="menu_copy_id"  onclick="copy_id_node()">Copy &lt;id&gt;</li>
  <li id="menu_save_svg" onclick="save_svg_node()">Save image</li>
  <li id="menu_pan_test" onclick="pan_test_node()">Pan test</li>
</ul>

  <script src="./modules/viz.js/viz.js"></script>
  <script src="./modules/fabric.js/dist/fabric.min.js"></script>
  <script src="./modules/Split.js/split.min.js"></script>
  <script src="./modules/svg-pan-zoom/svg-pan-zoom-es.js"></script>
  <script src="./scripts/color.js"></script>
  <script src="./scripts/oreqm.js"></script>
  <script src="./scripts/ReqM2Oreqm.js"></script>
  <script>

  var beforeUnloadMessage = null;

  var resizeEvent = new Event("paneresize");
  Split(['#oreqm_div', '#graph'], {
    sizes: [15, 85],
    onDragEnd: function() {
      var svgOutput = document.getElementById("svg_output");
      if (svgOutput != null) {
        svgOutput.dispatchEvent(resizeEvent);
      }
    }
  });

  var parser = new DOMParser();
  var worker;
  var result;
  var title
  var oreqm_main
  var oreqm_main_filename = 'no file selected'
  var oreqm_main_timestamp = 'no time'
  var oreqm_ref
  var oreqm_ref_filename = ''
  var oreqm_ref_timestamp = ''
  var image_type = 'none'
  var image_mime = ''
  var image_data = ''
  var image_data_url = ''
  var auto_update = true
  var search_pattern = '' // regex for matching requirements
  var id_checkbox = false // flag for scope of search
  var dot_source = ''
  var panZoom = null

  document.getElementById("auto_update").checked = auto_update

  function viz_working_set() {
    document.getElementById("viz_working").innerHTML = '<span style="color: #ff0000">WORKING</span>'
  }

  function viz_working_clear() {
    document.getElementById("viz_working").innerHTML = '<span style="color: #000000"></span>'
  }

  function updateGraph() {
    if (worker) {
      worker.terminate();
    }

    document.querySelector("#output").classList.add("working");
    document.querySelector("#output").classList.remove("error");

    worker = new Worker("./scripts/worker.js");

    worker.onmessage = function(e) {
      document.querySelector("#output").classList.remove("working");
      document.querySelector("#output").classList.remove("error");

      result = e.data;

      viz_working_clear()
      updateOutput();
    }

    worker.onerror = function(e) {
      document.querySelector("#output").classList.remove("working");
      document.querySelector("#output").classList.add("error");

      var message = e.message === undefined ? "An error occurred while processing the graph input." : e.message;

      var error = document.querySelector("#error");
      while (error.firstChild) {
        error.removeChild(error.firstChild);
      }

      document.querySelector("#error").appendChild(document.createTextNode(message));

      console.error(e);
      console.log(dot_source)
      viz_working_clear()
      e.preventDefault();
    }

    dot_source = oreqm_main != null ? oreqm_main.get_dot() : "digraph foo {\nfoo -> bar\nfoo -> baz\n}\n"
    var params = {
      src: dot_source,
      options: {
        engine: "dot", //document.querySelector("#engine select").value,
        format: document.querySelector("#format select").value
        , totalMemory: 4 * 16 * 1024 *1024
      }
    };

    // Instead of asking for png-image-element directly, which we can't do in a worker,
    // ask for SVG and convert when updating the output.

    if (params.options.format === "png-image-element") {
      params.options.format = "svg";
    }

    worker.postMessage(params);
    viz_working_set()
  }

  var selected_node = ''
  var svg_element = null
  function updateOutput() {
    var graph = document.querySelector("#output");

    var svg = graph.querySelector("svg");
    if (svg) {
      graph.removeChild(svg);
    }

    var text = graph.querySelector("#text");
    if (text) {
      graph.removeChild(text);
    }

    var img = graph.querySelector("img");
    if (img) {
      graph.removeChild(img);
    }

    if (!result) {
      return;
    }

    if (document.querySelector("#format select").value === "svg" && !document.querySelector("#raw input").checked) {
      svg_element = parser.parseFromString(result, "image/svg+xml").documentElement;
      svg_element.id = "svg_output";
      graph.appendChild(svg_element);

      panZoom = svgPanZoom(svg_element, {
        panEnabled: true,
        zoomEnabled: true,
        dblClickZoomEnabled: false,
        controlIconsEnabled: true,
        preventMouseEventsDefault: false,
        fit: true,
        center: true,
        minZoom: 0.02,
        maxZoom: 200,
        zoomScaleSensitivity: 0.3
      });

      svg_element.addEventListener('paneresize', function(e) {
        panZoom.resize();
      }, false);
      window.addEventListener('resize', function(e) {
        panZoom.resize();
      });

      // This time, add the listener to the graph itself
      svg_element.addEventListener('click', event => {
        let str = ""
        if (!event.altKey) { // This test allows Alt-drag to function
          // Grab all the siblings of the element that was actually clicked on
          for (const sibling of event.target.parentElement.children) {
            // Check if they're the title
            if (sibling.nodeName != 'title') continue;
            str = sibling.innerHTML;
            break;
          }
          const ta = document.createElement('textarea');
          ta.value = str;
          ta.setAttribute('readonly', '');
          ta.style = { position: 'absolute', left: '-9999px' };
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
      });

      svg_element.onkeyup = function(e) {
        if (e.which == 77) {
          //alert("M key was pressed");
          pan_test_node()
        } else if (e.ctrlKey && e.which == 66) {
          alert("Ctrl + B shortcut combination was pressed");
        } else if (e.ctrlKey && e.altKey && e.which == 89) {
          alert("Ctrl + Alt + Y shortcut combination was pressed");
        } else if (e.ctrlKey && e.altKey && e.shiftKey && e.which == 85) {
          alert("Ctrl + Alt + Shift + U shortcut combination was pressed");
        }
      };

      // context menu setup
      var menuNode = document.getElementById('node-menu');
      svg_element.addEventListener('contextmenu', event => {
        let str = ""
        event.preventDefault()
        // Grab all the siblings of the element that was actually clicked on
        for (const sibling of event.target.parentElement.children) {
          // Check if they're the title
          if (sibling.nodeName != 'title') continue;
          str = sibling.innerHTML;
          break;
        }
        selected_node = str
        if (selected_node.length) {
          
          if ((menuNode.style.display==='none')) {
            // show context menu
            let stage = document.getElementById('output');
            var containerRect = stage.getBoundingClientRect();
            menuNode.style.display = 'initial';
            menuNode.style.top = "0"
            menuNode.style.left = "0"
            let menu_width = menuNode.clientWidth
            let menu_height = menuNode.clientHeight
            let menu_rel_x = 2
            let menu_rel_y = 2
            if ((event.pageX+menu_width+menu_rel_x+20) >= containerRect.right) {
              menu_rel_x = -menu_rel_x - menu_width
            }
            if ((event.pageY+menu_height+menu_rel_y+28) >= containerRect.bottom) {
              menu_rel_y = -menu_rel_y - menu_height - 16 // TODO: fix height of a row
            }
            menuNode.style.top  = /*containerRect.top  +*/ event.pageY + menu_rel_y + 'px';
            menuNode.style.left = /*containerRect.left +*/ event.pageX + menu_rel_x + 'px';
          } else {
            // Remove on 2nd right-click
            menuNode.style.display = 'none';
          }
        }
      });

      window.addEventListener('click', function(e) {
        // hide context menu
        if (menuNode.style.display !== 'none') {
          menuNode.style.display = 'none';
          e.preventDefault();
        }
      });

      // Setup for download of image
      image_type = 'svg'
      image_mime = 'image/svg+xml'
      image_data = result
    } else if (document.querySelector("#format select").value === "png-image-element") {
      var image = Viz.svgXmlToPngImageElement(result);
      graph.appendChild(image);
      image_type = 'png'
      image_mime = 'image/png'
      image_data = image
    } else {
      var text = document.createElement("div");
      text.id = "text";
      text.appendChild(document.createTextNode(result));
      graph.appendChild(text);
      image_type = 'txt'
      image_mime = 'text/plain'
      image_data = result
    }
    set_download_link()
  }

  window.addEventListener("beforeunload", function(e) {
    return beforeUnloadMessage;
  });

  /*
  document.querySelector("#engine select").addEventListener("change", function() {
      updateGraph();
    }); */

  document.querySelector("#format select").addEventListener("change", function() {
    if (document.querySelector("#format select").value === "svg") {
      document.querySelector("#raw").classList.remove("disabled");
      document.querySelector("#raw input").disabled = false;
    } else {
      document.querySelector("#raw").classList.add("disabled");
      document.querySelector("#raw input").disabled = true;
    }

    updateGraph();
  });

  document.querySelector("#raw input").addEventListener("change", function() {
    updateOutput();
  });

  function set_doctype_count_shown(visible_nodes) {
    // Update doctype table with counts of nodes actually displayed
    const doctypes = visible_nodes.keys()
    for (const doctype of doctypes) {
      const cell_name = "doctype_shown_{}".format(doctype)
      let cell = document.getElementById(cell_name)
      if (cell) {
        cell.innerHTML = visible_nodes.get(doctype).length
      }
    }
  }

  function update_doctype_table() {
    if (oreqm_main) {
      display_doctypes_with_count(oreqm_main.doctypes)
      if (auto_update) {
        filter_graph()
      }
    }
  }

  function display_doctypes_with_count(doctype_dict) {
    let doctype_names = Array.from(doctype_dict.keys())
    doctype_names.sort()
    let excluded = get_excluded_doctypes() // so we can tick them again
    //console.log(doctype_names)

    const element = document.getElementById("dyn_doctype_table");
    if (element) {
      element.parentNode.removeChild(element);
    }
    let table = document.createElement("table")
    table.id = "dyn_doctype_table"
    let row = table.insertRow();
    let cell
    table.className = 'doctype_table'
    cell = row.insertCell();
    cell.innerHTML = "<b>doctype</b>";
    cell = row.insertCell();
    cell.innerHTML = "<b>count</b>";
    cell = row.insertCell();
    cell.innerHTML = "<b>select</b>";
    cell = row.insertCell();
    cell.innerHTML = "<b>exclude</b>";
    for (var i of doctype_names) {
      row = table.insertRow();
      row.style.backgroundColor = get_color(i)
      cell = row.insertCell();
      cell.innerHTML = i;

      cell = row.insertCell();
      cell.innerHTML = doctype_dict.get(i).length;

      cell = row.insertCell();
      cell.innerHTML = '<div id="doctype_shown_{}">0</div>'.format(i)

      cell = row.insertCell();
      let checked = excluded.includes(i)
      cell.innerHTML = '<input type="checkbox" id="doctype_{}" {}>'.format(i, checked ? 'checked' : '')
      cell.addEventListener("click", function() {
        doctype_filter_change();
      });
    }
    document.getElementById("doctype_table").appendChild(table);
  }

  var toggle_doctype_exclude = false

  function doctype_filter_change() {
    if (!toggle_doctype_exclude) {
      //console.log("doctype_filter_change")
      if (auto_update) {
        filter_graph()
      }
    }
  }

  function auto_update_click() {
    //console.log("auto_update_click")
    auto_update = document.getElementById("auto_update").checked
  }

  function filter_change() {
    //console.log("filter_change")
    if (auto_update) {
      filter_graph()
    }
  }

  function set_auto_update(state) {
    document.getElementById("auto_update").checked = state
    auto_update = state
  }

  function get_main_oreqm_file() {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = '.oreqm'

    input.onchange = e => {
      // getting a hold of the file reference
      let file = e.target.files[0];
      // setting up the reader
      let reader = new FileReader();
      reader.readAsText(file,'UTF-8');
      reader.onload = readerEvent => {
        //console.log( file );
        oreqm_main = new ReqM2Oreqm(readerEvent.target.result, [], [])
        oreqm_main_filename = file.name
        oreqm_main_timestamp = oreqm_main.get_time()
        document.getElementById('name').innerHTML = oreqm_main_filename
        document.getElementById('size').innerHTML = (Math.round(file.size/1024))+" KiB"
        document.getElementById('timestamp').innerHTML = oreqm_main_timestamp
        const node_count = oreqm_main.get_node_count()
        if (auto_update && node_count > 500) {
          set_auto_update(false)
        }
        if (oreqm_ref) { // if we have a reference do a compare
          compare_oreqm()
        }
        display_doctypes_with_count(oreqm_main.get_doctypes())
        if (auto_update) {
          filter_graph()
        }
        let ref_button = document.getElementById('get_ref_oreqm')
        ref_button.disabled = false
        let clear_button = document.getElementById('clear_ref_oreqm')
        clear_button.disabled = false
      }
    }
    input.click();
  }

  function get_ref_oreqm_file() {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = '.oreqm'

    input.onchange = e => {
      // getting a hold of the file reference
      let file = e.target.files[0];
      // setting up the reader
      let reader = new FileReader();
      reader.readAsText(file,'UTF-8');
      reader.onload = readerEvent => {
        //console.log( file );
        oreqm_main.remove_ghost_requirements()
        oreqm_ref = new ReqM2Oreqm(readerEvent.target.result, [], [])
        oreqm_ref_filename = file.name
        oreqm_ref_timestamp = oreqm_main.get_time()
        document.getElementById('ref_name').innerHTML = oreqm_ref_filename
        document.getElementById('ref_size').innerHTML = (Math.round(file.size/1024))+" KiB"
        document.getElementById('ref_timestamp').innerHTML = oreqm_ref_timestamp
        compare_oreqm()
        display_doctypes_with_count(oreqm_main.get_doctypes())
        if (auto_update) {
          filter_graph()
        }
      }
    }
    input.click();
  }

  function set_download_link() {
    let download = document.getElementById('download_image')
    let link = document.getElementById('a_link_id')
    if (!link) {
      link = document.createElement("a"); // Or maybe get it from the current document
      link.id = "a_link_id"
      download.appendChild(link); // Or append it whereever you want
      link.innerHTML = "download image";
    }
    var image_blob = new Blob([image_data], {type: image_mime})
    image_data_url = URL.createObjectURL(image_blob);
    link.href = image_data_url;
    link.download = "visual_reqm2.{}".format(image_type);
  }

  function get_excluded_doctypes() {
    // Get the list of doctypes with checked 'excluded' status
    let excluded_list = []
    if (oreqm_main) {
      const doctypes = oreqm_main.get_doctypes()
      const names = doctypes.keys()
      for (const doctype of names) {
        const cb_name = "doctype_{}".format(doctype)
        const status = document.getElementById(cb_name);
        if (status && status.checked) {
          excluded_list.push(doctype)
        }
        //console.log(doctype, status)
      }
    }
    return excluded_list
  }

  function toggle_exclude() {
    if (oreqm_main) {
      toggle_doctype_exclude = true
      const doctypes = oreqm_main.get_doctypes()
      const names = doctypes.keys()
      let ex_list = get_excluded_doctypes()
      for (const doctype of names) {
        const checkbox_id = "doctype_{}".format(doctype)
        const new_state = ex_list.length==0
        var elm = document.getElementById(checkbox_id);
        if (new_state != elm.checked) {
          elm.click();
        }
      }
      toggle_doctype_exclude = false
      doctype_filter_change();
    }
  }

  function get_search_regex_clean() {
    let raw_search = document.getElementById("search_regex").value
    let clean_search = raw_search.replace(/\n/g, '') // ignore all newlines in regex
    return clean_search
  }

  function filter_graph() {
    if (oreqm_main) {
      handle_pruning()
      // Collect filter criteria and generate .dot data
      id_checkbox = document.querySelector("#id_checkbox input").checked
      search_pattern = get_search_regex_clean()
      //console.log("filter_graph()", search_pattern)
      if (search_pattern) {
        if (id_checkbox) {
          id_search(search_pattern)
        } else {
          txt_search(search_pattern)
        }
      } else {
        // no pattern specified
        if (false && oreqm_ref) {  // disable
          // If reference file exist use differences as filter
          oreqm_main.color_up_down([], COLOR_UP, COLOR_DOWN)
          graph = oreqm_main.create_graph(select_color, "reqspec1", construct_graph_title(), [])
          set_doctype_count_shown(graph.doctype_dict)
        } else {
          graph = oreqm_main.create_graph(select_all, "reqspec1", construct_graph_title(), [])
          set_doctype_count_shown(graph.doctype_dict)
        }
      }
      updateGraph();
    }
  }

  function handle_pruning() {
    if (oreqm_main) {
      let ex_id_list = []
      const excluded_ids = document.getElementById("excluded_ids").value.trim()
      if (excluded_ids.length) {
        ex_id_list = excluded_ids.split(/[\n,]+/)
      }
      oreqm_main.set_excluded_ids(ex_id_list)
      let ex_dt_list = get_excluded_doctypes()
      oreqm_main.set_excluded_doctypes(ex_dt_list)
    }
  }

  function id_search(regex) {
    var results = oreqm_main.find_reqs_with_name(regex)
    oreqm_main.clear_colors()
    oreqm_main.color_up_down(results, COLOR_UP, COLOR_DOWN)
    graph = oreqm_main.create_graph(select_color, "reqspec1", construct_graph_title(), results)
    set_doctype_count_shown(graph.doctype_dict)
  }

  function txt_search(regex) {
    var results = oreqm_main.find_reqs_with_text(regex)
    oreqm_main.clear_colors()
    oreqm_main.color_up_down(results, COLOR_UP, COLOR_DOWN)
    graph = oreqm_main.create_graph(select_color, "reqspec1", construct_graph_title(), results)
    set_doctype_count_shown(graph.doctype_dict)
  }

  function clear_reference()
  {
    if (oreqm_ref) {
      oreqm_ref = null
      oreqm_main.remove_ghost_requirements(true)
      document.getElementById('ref_name').innerHTML = ''
      document.getElementById('ref_size').innerHTML = ''
      document.getElementById('ref_timestamp').innerHTML = ''
      if (auto_update) {
        filter_graph()
      }
    }
  }

    // Get the modal
  var modal = document.getElementById("myModal");

  // Get the button that opens the modal
  var btn = document.getElementById("myBtn");

  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[0];

  // When the user clicks the button, open the modal
  btn.onclick = function() {
    modal.style.display = "block";
  }

  // When the user clicks on <span> (x), close the modal
  span.onclick = function() {
    modal.style.display = "none";
  }

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

  // When the user clicks anywhere outside of the modal, close it
  window.onbeforeunload = function(event) {
    return //"Graph is going away..."
  }

  function select_node() {
    // Add node to the selection criteria (if not already selected)
    let node = selected_node
    let node_select_str = "{}$".format(node)
    let search_pattern = document.getElementById("search_regex").value.trim()
    if (!search_pattern.includes(node_select_str)) {
      if (search_pattern.length) {
        node_select_str = '\n|'+node_select_str
      }
      search_pattern += node_select_str
      //document.querySelector("#id_checkbox input").checked = true
      document.getElementById("search_regex").value = search_pattern
      filter_change()
    }
  }

  function deselect_node() {
    // Remove node to the selection criteria (if not already selected)
    let node = selected_node
    let node_select_str = new RegExp("(^|\\|){}\\$".format(node))
    let org_search_pattern = document.getElementById("search_regex").value.trim()
    let search_pattern = org_search_pattern.replace(/\n/g, '')
    let new_search_pattern = search_pattern.replace(node_select_str, '')
    if (new_search_pattern[0] === '|') {
      new_search_pattern = new_search_pattern.slice(1)
    }
    new_search_pattern = new_search_pattern.replace(/\|/g, '\n|')
    if (new_search_pattern !== search_pattern) {
      document.getElementById("search_regex").value = new_search_pattern
      //console.log("deselect_node() - search ", node, search_pattern, new_search_pattern)
      filter_change()
    } else {
      alert_text = "'{}' is not a selected node\nPerhaps try 'Exclude'?".format(node)
      alert(alert_text)
    }
  }

  function exclude_node() {
    // Add node to the exclusion list
    var excluded_ids = document.getElementById("excluded_ids").value.trim()
    if (excluded_ids.length) {
      excluded_ids += '\n' + selected_node
    } else {
      excluded_ids = selected_node
    }
    document.getElementById("excluded_ids").value = excluded_ids
    filter_change()
  }

  function clear_search_regex() {
    document.getElementById("search_regex").value = ""
    filter_change()
  }

  function clear_excluded_ids() {
    document.getElementById("excluded_ids").value = ""
    filter_change()
  }

  function pan_test_node() {
    center_node("corbos.LNX.OperatingSystem")
  }

  function center_node(node_name) {
    // Grab all the siblings of the element that was actually clicked on
    let search_term = ".node[title='{}']".format(node_name)
    let found = false
    let bbox = null
    let viewport = document.querySelectorAll('.node > title');
    let titles = document.querySelectorAll('.node > title');
    for (const node of titles ) {
      if (node.innerHTML === node_name) {
        found = true
        bb = node.parentNode.getBBox()
        console.log("BBox", bb, node_name)
        break;
      }
    }
    if (found) {
      let output = document.getElementById("output");
      let sizes = panZoom.getSizes()
      let rz = sizes.realZoom;
      let pan = panZoom.getPan()
      let window_width = output.clientWidth/rz
      let window_height = output.clientHeight/rz
      console.log("Sizes", sizes)
      console.log("ViewBox", sizes.viewBox)
      console.log("Pan", pan)
      
      let centerpos_x = sizes.viewBox.width * 0.5
      let centerpos_y = sizes.viewBox.height * 0.5
      if (window_width > sizes.viewBox.width)
      centerpos_x += (window_width-sizes.viewBox.width) * 0.5
      if (window_width < sizes.viewBox.width)
        centerpos_x -= (sizes.viewBox.width-window_width) * 0.5
      if (window_height > sizes.viewBox.height)
        centerpos_y += (window_height-sizes.viewBox.height) * 0.5
      if (window_height < sizes.viewBox.height)
        centerpos_y -= (sizes.viewBox.height-window_height) * 0.5
      console.log(centerpos_x, centerpos_y)
      let req_center_x = bb.x + bb.width * 0.5
      let req_center_y = bb.y
      let pan_vector_x = (centerpos_x - req_center_x)*rz
      let pan_vector_y = (centerpos_y - req_center_y)*rz
      console.log(pan_vector_x, pan_vector_y)
      panZoom.pan({x: pan_vector_x, y: pan_vector_y});
    }
  }

    </script>
  </body>
</html>
